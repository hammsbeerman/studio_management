
{% load crispy_forms_tags %}
{% load static %}

<script>
  $(document).ready(function () {
    $("#customer").select2();
    $('#customer').on('select2:select', (e) => {
      htmx.trigger("#customer", "change");
    });
  });
</script>

{% block content %}

<select
  class="custom-select mb-4"
  id="customer"
  name="customers"
  hx-get="{% url 'customers:expanded_detail' %}"
  hx-target="#customers"
  hx-trigger="change, itemListChanged from:body"
>
  {% if customer %}
    <option value="{{ customer.id }}" selected>{{ customer }}</option>
  {% else %}
    <option value="" selected>Select Customer</option>
  {% endif %}

  {% for x in customers %}
    <option value="{{ x.id }}">{{ x.company_name }}</option>
  {% endfor %}
</select>

{% if customer %}

<ul class="nav nav-tabs" id="customerTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-overview" data-bs-toggle="tab" data-bs-target="#pane-overview" type="button" role="tab">
      Overview
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-active" data-bs-toggle="tab" data-bs-target="#pane-active" type="button" role="tab">
      Active ({{ workorders|length }})
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-completed" data-bs-toggle="tab" data-bs-target="#pane-completed" type="button" role="tab">
      Completed
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-quotes" data-bs-toggle="tab" data-bs-target="#pane-quotes" type="button" role="tab">
      Quotes
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-payments" data-bs-toggle="tab" data-bs-target="#pane-payments" type="button" role="tab">
      Payments
    </button>
  </li>
</ul>

<div class="tab-content pt-3" id="customerTabsContent">

  <!-- OVERVIEW -->
  <div class="tab-pane fade show active" id="pane-overview" role="tabpanel" aria-labelledby="tab-overview">
    <div class="row">
      <div class="col-md-3 mb-sm-0">
        <div id="customer-info-card" class="card"
             hx-trigger="CustomerAdded from:body"
             hx-get="{% url 'customers:cust_info' %}?customer={{ customer.id }}"
             hx-target="this">
          {% include 'customers/partials/customer_info.html' %}
        </div>
      </div>

      <div class="col-md-3">
        <div id="contact-card" class="card"
             hx-trigger="ContactChanged from:body"
             {% if contact %}
               hx-get="{% url 'customers:details_contact_info' %}?contact={{ contact.id }}&customer={{ customer.id }}"
             {% else %}
               hx-get="{% url 'customers:details_contact_info' %}?customer={{ customer.id }}"
             {% endif %}
             hx-target="this">
          {% include 'customers/partials/details_contact_info.html' %}
        </div>
      </div>

      <div class="col-md-3">
        <div class="card">
          <div class="card-header">Financial Details</div>
          <div class="card-body">
            {% include 'workorders/partials/finance.html' %}
          </div>
          <div class="card-footer"></div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card">
          <div class="card-header">Customer Order History</div>
          <div class="card-body">
            {% include 'workorders/partials/workorder_history.html' %}
          </div>
          <div class="card-footer"></div>
        </div>
      </div>
    </div>

    {% include 'customers/partials/icon_legend.html' %}
  </div>

  <!-- ACTIVE -->
  <div class="tab-pane fade" id="pane-active" role="tabpanel" aria-labelledby="tab-active">
    <div class="row">
      <div class="col-md-6">
        <h6 class="mb-2">Active Workorders</h6>
        <table class="table table-sm">
          {% for x in workorders %}
            <tr>
              <td>
                <a href="{{ x.get_absolute_url }}">{{ x.workorder }} — {{ x.description }}</a>
              </td>
              <td class="text-end" style="width:40px;">
                {% if x.workorder_status and x.workorder_status.icon %}
                  <img src="{{ x.workorder_status.icon.url }}" style="width:20px;height:20px;">
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td class="text-muted">No active workorders.</td></tr>
          {% endfor %}
        </table>
      </div>

      <div class="col-md-6">
        <h6 class="mb-2">Recent History</h6>
        <table class="table table-sm">
          {% for x in history %}
            <tr>
              <td>
                <a href="{{ x.get_absolute_url }}">{{ x.workorder }} — {{ x.description }}</a>
              </td>
              <td class="text-end" style="width:160px;">{{ x.created|date:"M d, Y" }}</td>
            </tr>
          {% empty %}
            <tr><td class="text-muted">No history.</td></tr>
          {% endfor %}
        </table>
      </div>
    </div>
  </div>

  <!-- COMPLETED -->
  <div class="tab-pane fade" id="pane-completed" role="tabpanel" aria-labelledby="tab-completed">
    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>Workorder</th>
          <th>Date</th>
          <th class="text-center">Days Past Due</th>
          <th class="text-center">Paid</th>
          <th class="text-end">Amount</th>
        </tr>
      </thead>
      <tbody>
        {% for x in completed %}
          <tr>
            <td><a href="{{ x.get_absolute_url }}">{{ x.workorder }} — {{ x.description }}</a></td>
            <td>{{ x.date_completed|date:"M d, Y" }}</td>
            <td class="text-center">
              {% if x.billed and not x.paid_in_full and x.aging %}
                {{ x.aging }}
              {% endif %}
            </td>
            <td class="text-center">
              {% if x.billed %}
                {% if x.paid_in_full %}
                  <img src="{% static 'img/site/paidbill-50.png' %}" style="width:20px;height:20px;" title="Paid in Full">
                {% elif x.aging > 30 %}
                  <img src="{% static 'img/site/overduebill-50.png' %}" style="width:20px;height:20px;" title="Past 30 Days">
                {% else %}
                  <img src="{% static 'img/site/billed-50.png' %}" style="width:20px;height:20px;" title="Billed Out">
                {% endif %}
              {% endif %}
            </td>
            <td class="text-end">
              {{ x.workorder_total }}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5" class="text-muted">No completed workorders.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- QUOTES -->
  <div class="tab-pane fade" id="pane-quotes" role="tabpanel" aria-labelledby="tab-quotes">
    <table class="table table-sm">
      {% for x in quote %}
        <tr>
          <td>
            <a href="{{ x.get_absolute_url }}">{{ x.workorder }} — {{ x.description }}</a>
          </td>
          <td class="text-end" style="width:40px;">
            {% if x.workorder_status and x.workorder_status.icon %}
              <img src="{{ x.workorder_status.icon.url }}" style="width:20px;height:20px;">
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr><td class="text-muted">No quotes.</td></tr>
      {% endfor %}
    </table>
  </div>

  <!-- PAYMENTS -->
  <div class="tab-pane fade" id="pane-payments" role="tabpanel" aria-labelledby="tab-payments">
    <table class="table table-sm">
      <thead>
        <tr>
          <th>Date</th>
          <th>Amount</th>
          <th>Payment Type</th>
          <th>Number</th>
        </tr>
      </thead>
      <tbody>
        {% for x in payments %}
          <tr>
            <td>{{ x.date }}</td>
            <td>{{ x.amount }}</td>
            <td>{{ x.payment_type }}</td>
            <td>
              {% if x.check_number %}{{ x.check_number }}
              {% elif x.giftcard_number %}{{ x.giftcard_number }}
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="4" class="text-muted">No payments.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

{% endif %}

<div id="modal2" class="modal fade">
  <div id="dialog2" class="modal-dialog modal-lg" hx-target="this"></div>
</div>

{% endblock content %}

{% block scripts %}
<script>
  const modal2 = new bootstrap.Modal(document.getElementById("modal2"));

  htmx.on("htmx:afterSwap", (e) => {
    if (e.detail.target.id == "dialog2") modal2.show();
  });

  htmx.on("htmx:beforeSwap", (e) => {
    if (e.detail.target.id == "dialog2" && !e.detail.xhr.response) {
      modal2.hide();
      e.detail.shouldSwap = false;
    }
  });

  htmx.on("hidden.bs.modal", () => {
    document.getElementById("dialog2").innerHTML = "";
  });
</script>
{% endblock %}