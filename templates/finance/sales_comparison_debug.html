{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<h4>Sales Comparison Debug</h4>
<p class="text-muted small">
  This helps see where workorders drop out of the sales comparison report.
  Only staff should have access.
</p>

<div class="card mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      {% csrf_token %}
      <div class="col-md-3">
        {{ form.period1_start|as_crispy_field }}
      </div>
      <div class="col-md-3">
        {{ form.period1_end|as_crispy_field }}
      </div>
      <div class="col-md-3">
        {{ form.period2_start|as_crispy_field }}
      </div>
      <div class="col-md-3">
        {{ form.period2_end|as_crispy_field }}
      </div>

      <div class="col-md-4">
        {{ form.customer|as_crispy_field }}
      </div>

      <div class="col-md-4">
        {{ form.companies|as_crispy_field }}
      </div>

      <div class="col-md-4">
        {{ form.combine_companies|as_crispy_field }}
      </div>

      <div class="col-md-12">
        <button type="submit" class="btn btn-primary btn-sm mt-2">
          Run Debug
        </button>
      </div>
    </form>
  </div>
</div>

{% if steps %}
  {% if period1_label and period2_label %}
    <p>
      <strong>Period 1:</strong> {{ period1_label }}<br>
      <strong>Period 2:</strong> {{ period2_label }}
    </p>
  {% endif %}

  <table class="table table-sm table-striped align-middle">
    <thead>
      <tr>
        <th>Step</th>
        <th class="text-end">Total</th>
        <th>By company</th>
      </tr>
    </thead>
    <tbody>
      {% for step in steps %}
        <tr>
          <td>{{ step.label }}</td>
          <td class="text-end">{{ step.total }}</td>
          <td>
            {% if step.by_company %}
              <ul class="mb-0 ps-3">
                {% for row in step.by_company %}
                  <li>
                    {% if row.internal_company %}
                      {{ row.internal_company }}
                    {% else %}
                      <em>(no company set)</em>
                    {% endif %}
                    â€“ {{ row.count }}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <span class="text-muted">None</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p class="text-muted">
    Run the debug to see counts at each step.
  </p>
{% endif %}
{% endblock %}