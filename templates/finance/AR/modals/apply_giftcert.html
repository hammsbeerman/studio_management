<div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title">
      Apply Gift Certificate{% if giftcert.certificate_number %} #{{ giftcert.certificate_number }}{% endif %}
      — {{ customer.company_name }}
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
  </div>

  <div class="modal-body">
    {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}

    <div class="text-muted mb-2">
      Balance: <strong id="gc-available">{{ giftcert.balance|default_if_none:0|floatformat:2 }}</strong>
      {% if giftcert.certificate_number %} • #{{ giftcert.certificate_number }}{% endif %}
    </div>

    <form hx-post="{% url 'finance:apply_giftcert' %}"
          hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}'
          hx-swap="none">

      <input type="hidden" name="customer" value="{{ customer.id }}">
      <input type="hidden" name="gc" value="{{ giftcert.id }}">

      <div class="row g-2 mb-3">
        <div class="col-md-4">
          <label class="form-label">Date</label>
          <input class="form-control" type="date" name="date" value="{{ default_date|date:'Y-m-d' }}">
        </div>

        <div class="col-md-4">
          <label class="form-label">Amount to apply</label>
          <input class="form-control" type="number" step="0.01" min="0"
                 name="amount" id="apply-amount"
                 value="">
          <div class="form-text">Auto-fills from selected invoice; you can lower it for underpayment.</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Selected total</label>
          <input class="form-control" type="text" id="selected-total" value="0.00" readonly>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th style="width:1%; white-space:nowrap;"></th>
              <th>Workorder</th>
              <th>Description</th>
              <th class="text-end">Open</th>
            </tr>
          </thead>
          <tbody>
            {% for wo in workorders %}
              <tr>
                <td>
                  <input class="form-check-input wo-radio"
                         type="radio"
                         name="workorder"
                         value="{{ wo.id }}"
                         data-open="{{ wo.open_balance|default_if_none:0 }}">
                </td>
                <td style="white-space:nowrap;">WO {{ wo.workorder }}</td>
                <td>
                  {{ gc.description|default:"—" }}
                  {% if gc.sold_to %}
                    <div class="text-muted small">Sold to: {{ gc.sold_to }}</div>
                  {% endif %}
                </td>
                <td class="text-end">{{ wo.open_balance|floatformat:2 }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-muted">No open workorders.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3 d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Apply</button>
      </div>
    </form>
  </div>
</div>

<script>
(function () {
  const available = parseFloat((document.getElementById("gc-available")?.textContent || "0").replace(/,/g, "")) || 0;

  const amountInput = document.getElementById("apply-amount");
  const selectedTotalInput = document.getElementById("selected-total");
  const radios = Array.from(document.querySelectorAll(".wo-radio"));

  function selectedOpen() {
    const r = radios.find(x => x.checked);
    if (!r) return 0;
    return parseFloat((r.dataset.open || "0").toString().replace(/,/g, "")) || 0;
  }

  function updateAutoAmount() {
    const sel = selectedOpen();
    selectedTotalInput.value = sel.toFixed(2);

    if (!amountInput.dataset.userEdited || amountInput.dataset.userEdited !== "1") {
      const auto = Math.min(available, sel);
      amountInput.value = auto.toFixed(2);
    } else {
      const cur = parseFloat(amountInput.value || "0") || 0;
      const clamped = Math.max(0, Math.min(available, cur));
      if (clamped !== cur) amountInput.value = clamped.toFixed(2);
    }
  }

  amountInput?.addEventListener("input", () => {
    amountInput.dataset.userEdited = "1";
    updateAutoAmount();
  });

  for (const r of radios) r.addEventListener("change", updateAutoAmount);

  updateAutoAmount();
})();
</script>
