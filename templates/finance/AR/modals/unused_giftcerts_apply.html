<div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title">Apply Gift Certificate — {{ customer.company_name }}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
  </div>

  <div class="modal-body">

    <form class="row g-2 mb-3"
          hx-get="{% url 'finance:unused_giftcerts_apply_modal' %}"
          hx-target="#dialog"
          hx-swap="innerHTML">
      <input type="hidden" name="customer" value="{{ customer.id }}">
      <div class="col-md-8">
        <input class="form-control" name="q" value="{{ q }}" placeholder="Search number / description / sold to">
      </div>
      <div class="col-md-4 d-grid">
        <button class="btn btn-outline-secondary" type="submit">Search</button>
      </div>
    </form>

    <form hx-post="{% url 'finance:apply_giftcert' %}"
          hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}'
          hx-swap="none">

      <input type="hidden" name="customer" value="{{ customer.id }}">

      <div class="row g-2 mb-3">
        <div class="col-md-4">
          <label class="form-label">Date</label>
          <input class="form-control" type="date" name="date" value="{{ default_date|date:'Y-m-d' }}">
        </div>

        <div class="col-md-4">
          <label class="form-label">Amount to apply</label>
          <input class="form-control" type="number" step="0.01" min="0"
                 name="amount" id="apply-amount" value="">
          <div class="form-text">Auto-fills from selected GC + invoice.</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Selected open</label>
          <input class="form-control" type="text" id="selected-open" value="0.00" readonly>
        </div>
      </div>

      <div class="mb-2 fw-semibold">1) Select Gift Certificate</div>
      <div class="table-responsive mb-3">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th style="width:1%;"></th>
              <th>Number</th>
              <th>Issued</th>
              <th>Description</th>
              <th class="text-end">Balance</th>
              <th>Assigned</th>
            </tr>
          </thead>
          <tbody>
            {% for gc in giftcerts %}
              <tr>
                <td>
                  <input class="form-check-input gc-radio"
                         type="radio"
                         name="gc"
                         value="{{ gc.id }}"
                         data-balance="{{ gc.balance|default_if_none:0 }}">
                </td>
                <td style="white-space:nowrap;">{{ gc.certificate_number|default:gc.id }}</td>
                <td style="white-space:nowrap;">{{ gc.issued_date }}</td>
                <td>{{ gc.description|default:"—" }}</td>
                <td class="text-end">{{ gc.balance|floatformat:2 }}</td>
                <td>
                  {% if gc.customer_id %}
                    <span class="badge bg-secondary">Customer</span>
                  {% else %}
                    <span class="badge bg-info text-dark">Unassigned</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-muted">No unused gift certificates found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mb-2 fw-semibold">2) Select Workorder</div>
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th style="width:1%;"></th>
              <th>Workorder</th>
              <th>Description</th>
              <th class="text-end">Open</th>
            </tr>
          </thead>
          <tbody>
            {% for wo in workorders %}
              <tr>
                <td>
                  <input class="form-check-input wo-radio"
                         type="radio"
                         name="workorder"
                         value="{{ wo.id }}"
                         data-open="{{ wo.open_balance|default_if_none:0 }}">
                </td>
                <td style="white-space:nowrap;">WO {{ wo.workorder }}</td>
                <td>{{ wo.description|default:"—" }}</td>
                <td class="text-end">{{ wo.open_balance|floatformat:2 }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-muted">No open workorders.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3 d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Apply</button>
      </div>
    </form>
  </div>
</div>

<script>
(function () {
  const amountInput = document.getElementById("apply-amount");
  const selectedOpenInput = document.getElementById("selected-open");
  const gcRadios = Array.from(document.querySelectorAll(".gc-radio"));
  const woRadios = Array.from(document.querySelectorAll(".wo-radio"));

  function selectedBalance() {
    const r = gcRadios.find(x => x.checked);
    if (!r) return 0;
    return parseFloat((r.dataset.balance || "0").toString().replace(/,/g,"")) || 0;
  }
  function selectedOpen() {
    const r = woRadios.find(x => x.checked);
    if (!r) return 0;
    return parseFloat((r.dataset.open || "0").toString().replace(/,/g,"")) || 0;
  }

  function update() {
    const bal = selectedBalance();
    const open = selectedOpen();
    selectedOpenInput.value = open.toFixed(2);

    // auto fill unless user edited
    if (amountInput.dataset.userEdited !== "1") {
      const auto = Math.min(bal, open);
      amountInput.value = auto.toFixed(2);
    }
  }

  amountInput?.addEventListener("input", () => {
    amountInput.dataset.userEdited = "1";
  });
  gcRadios.forEach(r => r.addEventListener("change", update));
  woRadios.forEach(r => r.addEventListener("change", update));

  update();
})();
</script>