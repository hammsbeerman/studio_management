{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block content %}

{# High-level header block (summary/edit header via HTMX) #}
<div
  hx-trigger="load, itemChanged from:body"
  hx-get="{% url 'finance:invoice_detail_highlevel' id=invoice.pk %}"
  hx-target="this">
</div>

<div id="edit_invoice"></div>

<div class="container">

  <h4 class="mt-3">
    AP Invoice #{{ invoice.id }}
    {% if invoice.posted %}
      <span class="badge bg-warning text-dark">Posted</span>
    {% else %}
      <span class="badge bg-secondary">Not Posted</span>
    {% endif %}
  </h4>

  {% if amount_mismatch %}
    <div class="alert alert-warning mt-2">
      Header amount: <strong>{{ header_amount }}</strong><br>
      Item total: <strong>{{ item_total }}</strong><br>
      Difference: <strong>{{ amount_diff }}</strong>
    </div>
  {% endif %}

  <p></p>

  <table class="table">
    <thead>
      <tr>
        <th scope="col">Name</th>
        <th scope="col">Description</th>
        <th scope="col">Vendor Part Number</th>
        <th scope="col">Invoice Qty</th>
        <th scope="col">Invoice Unit</th>
        <th scope="col">Invoice Unit Price</th>
        <th scope="col">Unit Cost</th>
        <th scope="col">Qty</th>
        <th scope="col">Line Total</th>
        <th scope="col" class="text-end">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for x in items %}
        <tr>
          <td>{{ x.name }}</td>
          <td>{{ x.description }}</td>
          <td>{{ x.vendor_part_number }}</td>
          <td>{{ x.invoice_qty }}</td>
          <td>
            {% if x.invoice_unit %}
              {{ x.invoice_unit.variation.name }} / {{ x.invoice_unit.variation_qty }}
            {% endif %}
          </td>
          <td>
            {% if x.invoice_unit_cost %}
              ${{ x.invoice_unit_cost }}{% if x.ppm %} / M{% endif %}
            {% endif %}
          </td>
          <td>{{ x.unit_cost }}</td>
          <td>{{ x.qty }}</td>
          <td>{{ x.line_total }}</td>
          <td class="text-end">
            <button
              hx-trigger="click"
              hx-get="{% url 'finance:edit_invoice_item' invoice=invoice.id id=x.id %}"
              hx-target="#invoices"
              class="btn btn-secondary btn-sm"
              {% if invoice.posted %}
              onclick="return confirm('This invoice is marked as POSTED. Editing items may affect accounting history. Continue?');"
              {% endif %}
            >
              Edit
            </button>

            <a
              href="{% url 'finance:delete_invoice_item' invoice=invoice.id id=x.id %}"
              class="btn btn-danger btn-sm"
              {% if invoice.posted %}
              onclick="return confirm('This invoice is marked as POSTED. Deleting items may affect accounting history. Continue?');"
              {% endif %}
              role="button"
            >
              Delete
            </a>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <p></p>

  <div id="invoices" class="mb-3">
    {% if vendor.supplier %}
      <button
        hx-trigger="click"
        hx-get="{% url 'finance:add_invoice_item' invoice=invoice.id vendor=invoice.vendor.id %}"
        hx-target="#remainder"
        class="btn btn-danger"
        {% if invoice.posted %}
        onclick="return confirm('This invoice is marked as POSTED. Adding new items may affect accounting history. Continue?');"
        {% endif %}
      >
        Add Invoice Item
      </button>
    {% endif %}

    {% if vendor.online_store_vendor %}
      <button
        hx-trigger="click"
        hx-get="{% url 'finance:add_invoice_item' invoice=invoice.id vendor=invoice.vendor.id type=2 %}"
        hx-target="#remainder"
        class="btn btn-danger"
        {% if invoice.posted %}
        onclick="return confirm('This invoice is marked as POSTED. Adding new items may affect accounting history. Continue?');"
        {% endif %}
      >
        Add Online Store Item
      </button>
    {% endif %}

    <button
      hx-trigger="click"
      hx-get="{% url 'finance:add_invoice_item' invoice=invoice.id vendor=invoice.vendor.id type=1 %}"
      hx-target="#remainder"
      class="btn btn-danger"
      {% if invoice.posted %}
      onclick="return confirm('This invoice is marked as POSTED. Adding new items may affect accounting history. Continue?');"
      {% endif %}
    >
      Add Non Inventory Item
    </button>
  </div>

  <div id="remainder"></div>

  <div id="modal" class="modal fade">
    <div id="dialog" class="modal-dialog" hx-target="this"></div>
  </div>

  {# You mentioned modal2 in scripts; leaving hooks in case itâ€™s used by partials #}
  <div id="modal2" class="modal fade">
    <div id="dialog2" class="modal-dialog" hx-target="this"></div>
  </div>

</div>

{% endblock content %}

{% block scripts %}
<script>
  const modal = new bootstrap.Modal(document.getElementById("modal"))

  htmx.on("htmx:afterSwap", (e) => {
    // Response targeting #dialog => show the modal
    if (e.detail.target.id === "dialog") {
      modal.show()
    }
  })

  htmx.on("htmx:beforeSwap", (e) => {
    // Empty response targeting #dialog => hide the modal
    if (e.detail.target.id === "dialog" && !e.detail.xhr.response) {
      modal.hide()
      e.detail.shouldSwap = false
    }
  })

  htmx.on("hidden.bs.modal", () => {
    document.getElementById("dialog").innerHTML = ""
  })

  const modal2 = new bootstrap.Modal(document.getElementById("modal2"))

  htmx.on("htmx:afterSwap", (e) => {
    if (e.detail.target.id === "dialog2") {
      modal2.show()
    }
  })

  htmx.on("htmx:beforeSwap", (e) => {
    if (e.detail.target.id === "dialog2" && !e.detail.xhr.response) {
      modal2.hide()
      e.detail.shouldSwap = false
    }
  })

  htmx.on("hidden.bs.modal", () => {
    document.getElementById("dialog2").innerHTML = ""
  })
</script>
{% endblock %}