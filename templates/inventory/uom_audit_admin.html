{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">UOM Audit</h3>
    <div class="text-muted small">Inventory → UOM Audit</div>
  </div>

  <!-- FILTERS -->
  <form method="get" class="card mb-3">
    <div class="card-body">
      {{ form|crispy }}
      <div class="d-flex gap-2">
        <button class="btn btn-primary" type="submit">Run Audit</button>
        <a class="btn btn-outline-secondary" href="{% url 'inventory:uom_audit_admin' %}">Reset</a>
      </div>
    </div>
  </form>

  {% if result %}
    <!-- SUMMARY -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-3"><strong>Matched:</strong> {{ result.summary.matched }}</div>
          <div class="col-md-3"><strong>OK:</strong> {{ result.summary.ok }}</div>
          <div class="col-md-3"><strong>With issues:</strong> {{ result.summary.with_issues }}</div>
          <div class="col-md-3 text-muted">
            {% if result.summary.by_issue_code %}
              <span class="small">Issue counts available below</span>
            {% endif %}
          </div>
        </div>

        {% if result.summary.by_issue_code %}
          <hr class="my-2">
          <div class="small">
            {% for code, ct in result.summary.by_issue_code.items %}
              <span class="badge bg-warning text-dark me-1 mb-1">{{ code }}: {{ ct }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>

    <!-- RESULTS TABLE -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="min-width: 320px;">Item</th>
                <th style="min-width: 280px;">UOMs on item</th>
                <th style="min-width: 260px;">Flags</th>
                <th style="min-width: 260px;">Issues</th>
                <th style="min-width: 360px;">Fix (Base / Sell / Receive)</th>
              </tr>
            </thead>
            <tbody>
              {% for row in result.rows %}
                {% with item=row.item %}
                  {% with vars=item.variations.all %}
                    <tr>
                      <!-- ITEM -->
                      <td>
                        <div class="fw-semibold">
                          #{{ item.id }} {{ item.name }}
                        </div>
                        <div class="text-muted small">
                          {% if item.primary_vendor %}
                            {{ item.primary_vendor }}
                          {% else %}
                            No vendor
                          {% endif %}
                          {% if item.primary_vendor_part_number %}
                            · PN {{ item.primary_vendor_part_number }}
                          {% endif %}
                        </div>
                      </td>

                      <!-- UOMS -->
                      <td>
                        {% if vars %}
                          <div class="small">
                            {% for v in vars %}
                              <div class="mb-1">
                                <span class="badge bg-light text-dark border">
                                  {{ v.variation.name }} × {{ v.variation_qty }}
                                  {% if v.active %} active{% else %} inactive{% endif %}
                                  {% if v.is_base_unit %} base{% endif %}
                                  {% if v.is_default_sell_uom %} sell{% endif %}
                                  {% if v.is_default_receive_uom %} recv{% endif %}
                                  (#{{ v.id }})
                                </span>
                              </div>
                            {% endfor %}
                          </div>
                        {% else %}
                          <span class="text-muted small">No variations</span>
                        {% endif %}
                      </td>

                      <!-- FLAGS -->
                      <td class="small">
                        <div>Retail: <strong>{% if item.retail %}Yes{% else %}No{% endif %}</strong></div>
                        <div>Supplies: <strong>{% if item.supplies %}Yes{% else %}No{% endif %}</strong></div>
                        <div>Non-inv: <strong>{% if item.non_inventory %}Yes{% else %}No{% endif %}</strong></div>
                      </td>

                      <!-- ISSUES -->
                      <td>
                        {% if row.issues %}
                          <ul class="mb-0 small">
                            {% for issue in row.issues %}
                              <li><strong>{{ issue.code }}:</strong> {{ issue.message }}</li>
                            {% endfor %}
                          </ul>
                        {% else %}
                          <span class="text-success small">OK</span>
                        {% endif %}
                      </td>

                      <!-- FIX FORM (triple) -->
                      <td>
                        <form method="post" action="{% url 'inventory:uom_audit_apply' %}" class="p-2 border rounded">
                          {% csrf_token %}
                          <input type="hidden" name="item_id" value="{{ item.id }}">

                          <div class="mb-2">
                            <label class="form-label small mb-1">Base UOM</label>
                            <select class="form-select form-select-sm" name="base_measurement">
                              <option value="">(leave unchanged)</option>
                              {% for v in vars %}
                                <option value="{{ v.variation_id }}"
                                  {% if row.base and row.base.variation_id == v.variation_id %}selected{% endif %}>
                                  {{ v.variation.name }}
                                </option>
                              {% endfor %}
                            </select>
                            <div class="form-text small text-muted">
                              Sets the base to qty = 1.0000 for the selected measurement.
                            </div>
                          </div>

                          <div class="mb-2">
                            <label class="form-label small mb-1">Default Sell UOM</label>
                            <div class="d-flex gap-2">
                              <select class="form-select form-select-sm" name="sell_measurement">
                                <option value="">(leave unchanged)</option>
                                {% for v in vars %}
                                  <option value="{{ v.variation_id }}"
                                    {% if row.default_sell and row.default_sell.variation_id == v.variation_id %}selected{% endif %}>
                                    {{ v.variation.name }}
                                  </option>
                                {% endfor %}
                              </select>
                              <input
                                class="form-control form-control-sm"
                                type="number"
                                step="0.0001"
                                name="sell_qty"
                                value="{% if row.default_sell %}{{ row.default_sell.variation_qty }}{% else %}1.0000{% endif %}"
                                style="max-width: 120px;"
                                title="variation_qty for the chosen sell UOM">
                            </div>
                          </div>

                          <div class="mb-2">
                            <label class="form-label small mb-1">Default Receive UOM</label>
                            <div class="d-flex gap-2">
                              <select class="form-select form-select-sm" name="receive_measurement">
                                <option value="">(leave unchanged)</option>
                                {% for v in vars %}
                                  <option value="{{ v.variation_id }}"
                                    {% if row.default_receive and row.default_receive.variation_id == v.variation_id %}selected{% endif %}>
                                    {{ v.variation.name }}
                                  </option>
                                {% endfor %}
                              </select>
                              <input
                                class="form-control form-control-sm"
                                type="number"
                                step="0.0001"
                                name="receive_qty"
                                value="{% if row.default_receive %}{{ row.default_receive.variation_qty }}{% else %}1.0000{% endif %}"
                                style="max-width: 120px;"
                                title="variation_qty for the chosen receive UOM">
                            </div>
                          </div>

                          <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-primary" type="submit">Apply</button>
                            <a class="btn btn-sm btn-outline-secondary" href="{% url 'inventory:item_variation_details' item.id %}">
                              Open item
                            </a>
                          </div>
                        </form>

                        <div class="text-muted small mt-1">
                          Tip: If an item has ledger history, your view may block base changes (good).
                        </div>
                      </td>
                    </tr>
                  {% endwith %}
                {% endwith %}
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="text-muted small mt-2">
          Showing {{ result.rows|length }} rows (based on your audit limit).
        </div>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}