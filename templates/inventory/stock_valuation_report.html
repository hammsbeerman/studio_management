{% extends "base.html" %}
{% load humanize %}

{% block content %}
<h3>Inventory &mdash; Stock Valuation (by Master)</h3>

{% if page_obj.object_list %}
  <table class="table table-sm table-striped align-middle">
    <thead>
      <tr>
        <th>Master ID</th>
        <th>Name</th>
        <th>Description</th>
        <th>Vendor</th>
        <th class="text-end">On Hand</th>
        <th class="text-end">Unit Cost</th>
        <th class="text-end">Extended Value</th>
      </tr>
    </thead>
    <tbody>
      {% for row in page_obj %}
        {% with master=row.master on_hand=row.on_hand unit_cost=row.unit_cost value=row.value %}
          <tr
            hx-get="{% url 'inventory:master_inventory_modal' master.id %}"
            hx-target="#dialog"
            hx-swap="innerHTML"
            style="cursor:pointer;"
          >
            <td>{{ master.id }}</td>
            <td>{{ master.name }}</td>
            <td>{{ master.description }}</td>
            <td>{{ master.primary_vendor }}</td>
            <td class="text-end">{{ on_hand|floatformat:2 }}</td>
            <td class="text-end">{{ unit_cost|floatformat:4 }}</td>
            <td class="text-end">{{ value|floatformat:2 }}</td>
          </tr>
        {% endwith %}
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="6" class="text-end">Total Value (all pages)</th>
        <th class="text-end">{{ total_value|floatformat:2 }}</th>
      </tr>
    </tfoot>
  </table>

  <nav aria-label="Page navigation">
    <ul class="pagination pagination-sm">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
            Previous
          </a>
        </li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}">
            Next
          </a>
        </li>
      {% endif %}
    </ul>
  </nav>
{% else %}
  <p class="text-muted">No inventory items found.</p>
{% endif %}

<div id="modal" class="modal fade" tabindex="-1">
  <div id="dialog" class="modal-dialog modal-lg" hx-target="this"></div>
</div>
{% endblock content %}

{% block scripts %}
  {{ block.super }}
  <script>
    const inventoryModalEl = document.getElementById("modal");
    const inventoryModal = new bootstrap.Modal(inventoryModalEl);

    htmx.on("htmx:afterSwap", (e) => {
      if (e.detail.target.id === "dialog") {
        inventoryModal.show();
      }
    });

    htmx.on("htmx:beforeSwap", (e) => {
      if (e.detail.target.id === "dialog" && !e.detail.xhr.response) {
        inventoryModal.hide();
        e.detail.shouldSwap = false;
      }
    });

    htmx.on("hidden.bs.modal", () => {
      const dlg = document.getElementById("dialog");
      if (dlg) dlg.innerHTML = "";
    });
  </script>
{% endblock scripts %}