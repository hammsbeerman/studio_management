{% load crispy_forms_tags %}
<div class="modal-content">

  <div class="modal-header">
    <h5 class="modal-title">
      {% if sale.is_refund %}
        Refund for Sale #
        {{ sale.original_sale.id|default:sale.id }}
      {% else %}
        Take payment — Sale #{{ sale.id }}
      {% endif %}
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>

  <form
    method="post"
    hx-post="{% url 'retail:sale_payment_submit' sale.id %}"
    hx-target="#dialog"
    hx-swap="outerHTML"
  >
    <div class="modal-body">
      {% csrf_token %}

      {# Summary row: customer + totals #}
      <div class="row mb-3">
        <div class="col-md-6">
          <h6 class="mb-1">Customer</h6>
          {% if sale.customer %}
            <div>
              <strong>{{ sale.customer.company_name }}</strong><br>
              {{ sale.customer.city }}, {{ sale.customer.state }}
            </div>
          {% else %}
            <div class="text-muted">
              Walk-in / cash sale
            </div>
          {% endif %}
        </div>
        <div class="col-md-6 text-end">
          <h6 class="mb-1">
            {% if sale.is_refund %}
              Refund total
            {% else %}
              Sale total
            {% endif %}
          </h6>
          <div class="fs-4 fw-bold">
            ${{ total|floatformat:2 }}
          </div>
          <small class="text-muted">
            Subtotal ${{ subtotal|floatformat:2 }}
            • Tax ${{ tax|floatformat:2 }}
          </small>
        </div>
      </div>

      <hr>

      {# Payment / refund method #}
      <div class="mb-3">
        <label class="form-label">
          {% if sale.is_refund %}
            Refund method
          {% else %}
            Payment method
          {% endif %}
        </label>
        <div class="btn-group w-100" role="group">
          {% for value, label in form.payment_method.field.choices %}
            <input
              type="radio"
              class="btn-check"
              name="payment_method"
              id="pay-method-{{ value }}"
              value="{{ value }}"
              {% if form.payment_method.value == value %}checked{% endif %}
            >
            <label class="btn btn-outline-secondary" for="pay-method-{{ value }}">
              {{ label }}
            </label>
          {% endfor %}
        </div>
        {% if form.payment_method.errors %}
          <div class="text-danger small mt-1">{{ form.payment_method.errors.0 }}</div>
        {% endif %}
      </div>

      <div id="check-number-wrapper" class="mb-3" style="display:none;">
        {{ form.check_number|as_crispy_field }}
      </div>

      {# Amount + change/refund due #}
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="id_amount" class="form-label">
            {% if sale.is_refund %}
              Amount to refund
            {% else %}
              Amount received
            {% endif %}
          </label>
          <input
            type="number"
            step="0.01"
            class="form-control"
            name="amount"
            id="id_amount"
            value="{{ form.amount.value|default:total }}"
          >
          {% if form.amount.errors %}
            <div class="text-danger small mt-1">{{ form.amount.errors.0 }}</div>
          {% endif %}
          <div class="form-text">
            {% if sale.is_refund %}
              Default is the full refund total. Adjust for a partial refund.
            {% else %}
              Default is the full sale total. Change if taking partial payment.
            {% endif %}
          </div>
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label">
            {% if sale.is_refund %}
              Net change to customer
            {% else %}
              Change due (approx.)
            {% endif %}
          </label>
          <div id="change-due-display" class="fs-5">
            $0.00
          </div>
          <div class="form-text">
            Calculated from entered amount vs total.
          </div>
        </div>
      </div>

      {# Notes #}
      <div class="mb-3">
        <label for="id_notes" class="form-label">Notes (optional)</label>
        <textarea
          name="notes"
          id="id_notes"
          class="form-control"
          rows="2"
        >{{ form.notes.value }}</textarea>
        {% if form.notes.errors %}
          <div class="text-danger small mt-1">{{ form.notes.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="alert alert-info py-2 mb-0">
        <strong>What happens next?</strong><br>
        {% if sale.is_refund %}
          - A refund record will be created for this sale.<br>
          - The original POS total / linked workorder will reflect the net amount.
        {% else %}
          - The sale will be marked as paid and locked.<br>
          {% if sale.workorder %}
            - Workorder #{{ sale.workorder.workorder }} will reflect this payment.
          {% endif %}
        {% endif %}
      </div>
    </div>

    <div class="modal-footer">
      <button
        type="button"
        class="btn btn-outline-secondary"
        data-bs-dismiss="modal"
      >
        Cancel
      </button>

      <button
        type="submit"
        class="btn {% if sale.is_refund %}btn-warning{% else %}btn-success{% endif %}"
      >
        {% if sale.is_refund %}
          {% if total < 0 %}
            Issue Refund
          {% elif total > 0 %}
            Collect Payment
          {% else %}
            Finalize Exchange
          {% endif %}
        {% else %}
          Confirm Payment
        {% endif %}
      </button>
    </div>

  </form>
</div>

<script>
  (function () {
    // ----- Change / refund calculation -----
    const total = {{ total|floatformat:2 }};
    const amountInput = document.getElementById("id_amount");
    const changeDisplay = document.getElementById("change-due-display");

    function updateChange() {
      if (!amountInput || !changeDisplay) return;
      const val = parseFloat(amountInput.value || "0");
      const diff = val - total;

      if (isNaN(diff)) {
        changeDisplay.textContent = "$0.00";
        return;
      }

      const abs = Math.abs(diff).toFixed(2);
      let label = "$" + abs;
      if (diff < 0) {
        label = "-$" + abs;
      }
      changeDisplay.textContent = label;
    }

    if (amountInput) {
      amountInput.addEventListener("input", updateChange);
      updateChange();
    }

    // ----- Show/hide check number based on payment method radios -----
    const checkWrapper = document.getElementById("check-number-wrapper");
    const methodRadios = document.querySelectorAll('input[name="payment_method"]');

    function toggleCheckField() {
      if (!checkWrapper || !methodRadios.length) return;
      let selected = null;
      methodRadios.forEach(function (r) {
        if (r.checked) selected = r;
      });
      const val = selected ? selected.value : null;
      // Adjust "check" if your value is different
      checkWrapper.style.display = (val === "check") ? "" : "none";
    }

    methodRadios.forEach(function (r) {
      r.addEventListener("change", toggleCheckField);
    });

    // Run once on load to set initial state
    toggleCheckField();
  })();
</script>