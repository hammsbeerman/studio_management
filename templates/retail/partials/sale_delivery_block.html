{% comment %}
Sale Delivery / Pickup block

Rules:
- If sale.workorder exists:
    - We don't show local toggles – delivery/pickup is owned by the workorder.
    - We just display the current status/date derived from the workorder.
- If NO workorder yet:
    - We show two independent toggles so the cashier can mark
      "requires delivery" or "requires pickup".
    - Each toggle has its own date field.
{% endcomment %}

<div class="card">
  <div class="card-header">
    Delivery / Pickup
  </div>
  <div class="card-body">

    {% if sale.workorder %}
      {# Linked to a workorder: show read-only info that mirrors that workorder #}
      <p class="mb-1">
        <strong>Linked workorder:</strong>
        <a href="{{ sale.workorder.get_absolute_url }}" target="_blank">
          #{{ sale.workorder.workorder }} – {{ sale.workorder.description|default:"(no description)" }}
        </a>
      </p>

      <p class="mb-0">
        {% if sale.workorder.requires_delivery %}
          <span class="badge text-bg-primary">Delivery</span>
          {% if sale.workorder.delivery_date %}
            on {{ sale.workorder.delivery_date|date:"M j, Y" }}
          {% endif %}
        {% elif sale.workorder.requires_pickup %}
          <span class="badge text-bg-secondary">Pickup</span>
          {% if sale.workorder.date_called %}
            (called on {{ sale.workorder.date_called|date:"M j, Y" }})
          {% endif %}
        {% else %}
          <span class="text-muted">No delivery or pickup flagged.</span>
        {% endif %}
      </p>

      <p class="mt-2 small text-muted mb-0">
        To change delivery / pickup, open the workorder and use its toggle block.
      </p>

    {% else %}
      {# No workorder yet — allow the cashier to mark delivery or pickup #}

      <p class="small text-muted">
        This sale is not yet linked to a workorder. You can flag delivery or pickup here
        and set a date if needed.
      </p>

      <div class="d-flex flex-column gap-3">

        {# Delivery toggle + date #}
        <div>
          <form
            method="post"
            hx-post="{% url 'retail:sale_toggle_delivery' sale.id %}"
            hx-target="#sale-delivery-block"
            hx-swap="outerHTML"
          >
            {% csrf_token %}
            <div class="form-check form-switch mb-1">
              <input
                class="form-check-input"
                type="checkbox"
                name="requires_delivery"
                id="sale_requires_delivery_switch"
                {% if requires_delivery %}checked{% endif %}
                onchange="this.form.submit();"
              >
              <label class="form-check-label" for="sale_requires_delivery_switch">
                Mark for delivery
              </label>
            </div>
          </form>

          {# Date for delivery (only visible if flagged) #}
          {% if requires_delivery %}
            <form
              method="post"
              class="mt-1"
              hx-post="{% url 'retail:sale_update_delivery_date' sale.id %}"
              hx-target="#sale-delivery-block"
              hx-swap="outerHTML"
            >
              {% csrf_token %}
              <label for="sale_delivery_date" class="me-1 mb-0 small text-muted">
                Delivery date:
              </label>
              <input
                type="date"
                id="sale_delivery_date"
                name="delivery_date"
                class="form-control form-control-sm d-inline-block"
                style="width:auto;"
                value="{{ delivery_date|date:'Y-m-d' }}"
                hx-trigger="change"
              >
            </form>
          {% endif %}
        </div>

        <hr class="my-1">

        {# Pickup toggle + date_called #}
        <div>
          <form
            method="post"
            hx-post="{% url 'retail:sale_toggle_pickup' sale.id %}"
            hx-target="#sale-delivery-block"
            hx-swap="outerHTML"
          >
            {% csrf_token %}
            <div class="form-check form-switch mb-1">
              <input
                class="form-check-input"
                type="checkbox"
                name="requires_pickup"
                id="sale_requires_pickup_switch"
                {% if requires_pickup %}checked{% endif %}
                onchange="this.form.submit();"
              >
              <label class="form-check-label" for="sale_requires_pickup_switch">
                Mark for pickup
              </label>
            </div>
          </form>

          {# Date for pickup (date called) #}
          {% if requires_pickup %}
            <form
              method="post"
              class="mt-1"
              hx-post="{% url 'retail:sale_update_pickup_date' sale.id %}"
              hx-target="#sale-delivery-block"
              hx-swap="outerHTML"
            >
              {% csrf_token %}
              <label for="sale_pickup_date" class="me-1 mb-0 small text-muted">
                Date called:
              </label>
              <input
                type="date"
                id="sale_pickup_date"
                name="date_called"
                class="form-control form-control-sm d-inline-block"
                style="width:auto;"
                value="{{ date_called|date:'Y-m-d' }}"
                hx-trigger="change"
              >
            </form>
          {% endif %}
        </div>

      </div>
    {% endif %}
  </div>
</div>